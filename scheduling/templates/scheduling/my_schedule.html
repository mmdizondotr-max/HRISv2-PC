{% extends 'base.html' %}
{% load schedule_extras %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
             <h2>My Schedule</h2>

             <div class="d-flex gap-2">
                 {% if user.is_superuser or user.tier == 'supervisor' or user.tier == 'administrator' %}
                    <a href="{% url 'scheduling:schedule_history_list' %}" class="btn btn-outline-primary">
                        Published Schedule History
                    </a>
                 {% endif %}
             </div>
        </div>

        {% if schedules_data %}
            {% for data in schedules_data %}
                <div class="mb-5">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="mb-0">Schedule for Week of {{ data.schedule.week_start_date|date:"F j, Y" }}</h3>
                        {% if user.is_superuser or user.tier == 'supervisor' or user.tier == 'administrator' %}
                            {% if today < data.dates|last %}
                            <!-- Only show regenerate if there are remaining days in this week's view -->
                            <a href="{% url 'scheduling:regenerate_remaining_week' data.schedule.id %}" class="btn btn-warning btn-sm" onclick="return confirm('Are you sure you want to regenerate the remaining days of this week? Future shifts will be replaced.');">
                                Regenerate Remaining Week
                            </a>
                            {% endif %}
                        {% endif %}
                    </div>

                    {% if not data.schedule.is_published %}
                        <div class="alert alert-warning">This schedule is currently a DRAFT and has not been published.</div>
                    {% endif %}

                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    {% for shop in shops %}
                                        {% if shop.name == 'Roving' %}
                                            <th colspan="2" class="table-warning text-dark">{{ shop.name }}</th>
                                        {% else %}
                                            <th>{{ shop.name }}</th>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <th></th>
                                    {% for shop in shops %}
                                        {% if shop.name == 'Roving' %}
                                            <th class="table-warning text-dark">Duty</th>
                                            <th class="table-warning text-dark">Standby</th>
                                        {% else %}
                                            <th>Duty</th>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for date in data.dates %}
                                <tr>
                                    <td class="fw-bold">{{ date|date:"D, M d" }}</td>
                                    {% for shop in shops %}
                                        <!-- Duty Staff -->
                                        <td {% if shop.name == 'Roving' %}class="table-warning"{% endif %}>
                                            {% for shift in data.matrix|get_item:date|get_item:shop.id|get_item:'main' %}
                                                <div class="mb-1">
                                                    <!-- Editable Logic: User is Sup/Admin and Date is in future -->
                                                    {% if user.is_superuser or user.tier == 'supervisor' or user.tier == 'administrator' %}
                                                        {% if date > today %}
                                                            <a href="#" data-bs-toggle="modal" data-bs-target="#editShiftModal"
                                                               data-shift-id="{{ shift.id }}"
                                                               data-user-name="{{ shift.user.get_full_name }}"
                                                               class="badge bg-primary text-decoration-none">
                                                                {{ shift.user.get_short_name_for_schedule }} <i class="bi bi-pencil-square ms-1"></i>
                                                            </a>
                                                        {% else %}
                                                            <span class="badge bg-primary">{{ shift.user.get_short_name_for_schedule }}</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge bg-primary">{{ shift.user.get_short_name_for_schedule }}</span>
                                                    {% endif %}

                                                    <br>

                                                    {% if shift.status == 'absent' %}
                                                        <span class="text-danger small fw-bold">ABSENT</span>
                                                    {% elif shift.status == 'reported' %}
                                                        <span class="text-success small fw-bold">REPORTED</span>
                                                    {% elif shift.status == 'substituted' %}
                                                        <span class="text-danger">âžœ</span> <span class="badge bg-warning text-dark">{{ shift.actual_user.get_short_name_for_schedule }}</span>
                                                    {% elif shift.status == 'supplement' %}
                                                        <span class="text-success small fw-bold">SUPPLEMENT</span>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </td>
                                        <!-- Standby Staff -->
                                        {% if shop.name == 'Roving' %}
                                        <td class="table-warning">
                                            {% for shift in data.matrix|get_item:date|get_item:shop.id|get_item:'backup' %}
                                                <div class="mb-1">
                                                    <span class="badge bg-secondary">{{ shift.user.get_short_name_for_schedule }}</span>
                                                    {% if shift.status == 'reported' %}
                                                        <br><span class="text-success small fw-bold">REPORTED</span>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </td>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if data.change_logs %}
                    <div class="mt-4">
                        <h4>Change Log</h4>
                        <ul class="list-group">
                            {% for log in data.change_logs %}
                                <li class="list-group-item">
                                    <small class="text-muted">{{ log.created_at }}</small>
                                    <strong>{{ log.user.username|default:"System" }}:</strong> {{ log.message }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">No schedule available.</div>
        {% endif %}
    </div>
</div>

<!-- Edit Shift Modal -->
<div class="modal fade" id="editShiftModal" tabindex="-1" aria-labelledby="editShiftModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editShiftForm" method="POST" action="">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="editShiftModalLabel">Change Assigned Staff</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <p>Current Assignment: <span id="currentAssignedName" class="fw-bold"></span></p>
              <div class="mb-3">
                  <label for="new_user_select" class="form-label">Select New Staff:</label>
                  <select class="form-select" name="user_id" id="new_user_select" required>
                      <option value="">-- Select Staff --</option>
                      {% for u in all_users %}
                        <option value="{{ u.id }}">{{ u.get_full_name }} ({{ u.username }})</option>
                      {% endfor %}
                  </select>
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
      </form>
    </div>
  </div>
</div>

<script>
    var editShiftModal = document.getElementById('editShiftModal')
    editShiftModal.addEventListener('show.bs.modal', function (event) {
      // Button that triggered the modal
      var button = event.relatedTarget
      var shiftId = button.getAttribute('data-shift-id')
      var currentName = button.getAttribute('data-user-name')

      // Update the modal's content.
      var modalTitle = editShiftModal.querySelector('.modal-title')
      var nameSpan = editShiftModal.querySelector('#currentAssignedName')
      var form = editShiftModal.querySelector('#editShiftForm')

      nameSpan.textContent = currentName
      // Update form action
      form.action = "{% url 'scheduling:shift_update' 0 %}".replace('0', shiftId);
    })
</script>
{% endblock %}
