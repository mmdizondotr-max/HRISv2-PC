{% extends 'base.html' %}
{% load schedule_extras %}

{% block content %}
<div class="flex flex-col space-y-6">
    <div>
        <h2 class="text-2xl font-bold text-primary mb-4">Schedule Generation & Management</h2>

        <form method="post" class="flex flex-wrap gap-2 mb-6">
            {% csrf_token %}
            {% if current_schedule.is_published %}
                <button type="submit" name="generate" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-medium rounded shadow transition-colors" onclick="return confirm('Schedule is already published. Regenerating will wipe current shifts. Continue?')">Regenerate 4-Week Schedule</button>
                <button class="px-4 py-2 bg-gray-400 text-white font-medium rounded cursor-not-allowed" disabled>Week 1 Published</button>
            {% else %}
                <button type="submit" name="generate" class="px-4 py-2 bg-primary hover:bg-secondary text-white font-medium rounded shadow transition-colors">Generate 4-Week Schedule</button>
                {% if weeks_data %}
                    <button type="submit" name="publish" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded shadow transition-colors">Publish Week 1</button>
                    <button type="submit" name="clear" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded shadow transition-colors" onclick="return confirm('Clear generated schedule?')">Clear Generated Schedule</button>
                {% endif %}
            {% endif %}
        </form>

        {% if weeks_data %}

            <!-- Tabs Navigation -->
            <div class="border-b border-gray-200 mb-4">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs" id="scheduleTabs">
                    {% for week in weeks_data %}
                        <button class="tab-button {% if forloop.first %}border-primary text-primary{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center"
                                onclick="openTab(event, 'week-{{ forloop.counter }}')">
                            Week of {{ week.schedule.week_start_date|date:"M d" }}
                            {% if week.schedule.is_published %}
                                <span class="ml-2 py-0.5 px-2 rounded-full text-xs bg-green-100 text-green-800">Published</span>
                            {% endif %}
                        </button>
                    {% endfor %}
                </nav>
            </div>

            <!-- Tabs Content -->
            <div id="scheduleTabsContent">
                {% for week in weeks_data %}
                <div id="week-{{ forloop.counter }}" class="tab-content {% if not forloop.first %}hidden{% endif %}">
                    <h4 class="text-lg font-bold text-gray-700 mb-3">Week of {{ week.schedule.week_start_date }}</h4>
                    <div class="bg-white shadow overflow-hidden border border-gray-200 rounded-lg">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-center border-collapse">
                                <thead class="bg-primary text-white">
                                    <tr>
                                        <th class="px-2 py-2 border border-primary-dark">Date</th>
                                        {% for shop in shops %}
                                            {% if shop.name == 'Roving' %}
                                                <th class="px-2 py-2 border border-primary-dark bg-yellow-100 text-yellow-900 font-bold">{{ shop.name }}</th>
                                                <th class="px-2 py-2 border border-primary-dark bg-blue-100 text-blue-900 font-bold">Standby</th>
                                            {% else %}
                                                <th class="px-2 py-2 border border-primary-dark">{{ shop.name }}</th>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th class="px-2 py-2 border border-primary-dark"></th>
                                        {% for shop in shops %}
                                            {% if shop.name == 'Roving' %}
                                                <th class="px-2 py-2 border border-primary-dark bg-yellow-100 text-yellow-900 text-xs">Duty</th>
                                                <th class="px-2 py-2 border border-primary-dark bg-blue-100 text-blue-900 text-xs">Standby</th>
                                            {% else %}
                                                <th class="px-2 py-2 border border-primary-dark text-xs">Duty</th>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    {% for date in week.dates %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-2 py-2 border border-gray-200 font-bold text-gray-900 whitespace-nowrap text-sm">{{ date|date:"D, M d" }}</td>
                                        {% for shop in shops %}
                                            {% if shop.name == 'Roving' %}
                                                <!-- Roving Duty -->
                                                <td class="px-1 py-2 border border-gray-200 align-top bg-yellow-50">
                                                    <div class="flex flex-col space-y-1 items-center">
                                                    {% for shift in week.matrix|get_item:date|get_item:shop.id|get_item:'main' %}
                                                        <div class="relative group">
                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-primary text-white" title="Priority Score: {{ shift.score|floatformat:1 }}">
                                                                {{ shift.user.get_short_name_for_schedule }} ({{ shift.score|floatformat:1 }})
                                                                <span class="ml-1 bg-white text-gray-800 rounded-full px-1 text-[10px]">{{ week.duty_counts|get_item:shift.user.id|default:0 }}</span>
                                                            </span>
                                                            {% if not week.schedule.is_published or request.user.is_superuser %}
                                                                <a href="{% url 'scheduling:shift_delete' shift.id %}" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] hover:bg-red-800">x</a>
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                    {% if not week.schedule.is_published %}
                                                        <a href="{% url 'scheduling:shift_add' week.schedule.id date|date:'Y-m-d' shop.id 'main' %}" class="text-gray-400 hover:text-green-600 font-bold text-lg">+</a>
                                                    {% endif %}
                                                    </div>
                                                </td>
                                                <!-- Standby (Roving Backup) -->
                                                <td class="px-1 py-2 border border-gray-200 align-top bg-blue-50">
                                                    <div class="flex flex-col space-y-1 items-center">
                                                    {% for shift in week.matrix|get_item:date|get_item:shop.id|get_item:'backup' %}
                                                        <div class="relative group">
                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-500 text-white" title="Priority Score: {{ shift.score|floatformat:1 }}">
                                                                {{ shift.user.get_short_name_for_schedule }}
                                                            </span>
                                                            {% if not week.schedule.is_published or request.user.is_superuser %}
                                                                <a href="{% url 'scheduling:shift_delete' shift.id %}" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] hover:bg-red-800">x</a>
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                    {% if not week.schedule.is_published %}
                                                        <a href="{% url 'scheduling:shift_add' week.schedule.id date|date:'Y-m-d' shop.id 'backup' %}" class="text-gray-400 hover:text-green-600 font-bold text-lg">+</a>
                                                    {% endif %}
                                                    </div>
                                                </td>
                                            {% else %}
                                                <!-- Regular Shop Duty -->
                                                <td class="px-1 py-2 border border-gray-200 align-top">
                                                    <div class="flex flex-col space-y-1 items-center">
                                                    {% for shift in week.matrix|get_item:date|get_item:shop.id|get_item:'main' %}
                                                        <div class="relative group">
                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-primary text-white" title="Priority Score: {{ shift.score|floatformat:1 }}">
                                                                {{ shift.user.get_short_name_for_schedule }} ({{ shift.score|floatformat:1 }})
                                                                <span class="ml-1 bg-white text-gray-800 rounded-full px-1 text-[10px]">{{ week.duty_counts|get_item:shift.user.id|default:0 }}</span>
                                                            </span>
                                                            {% if not week.schedule.is_published or request.user.is_superuser %}
                                                                <a href="{% url 'scheduling:shift_delete' shift.id %}" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] hover:bg-red-800">x</a>
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                    {% if not week.schedule.is_published %}
                                                        <a href="{% url 'scheduling:shift_add' week.schedule.id date|date:'Y-m-d' shop.id 'main' %}" class="text-gray-400 hover:text-green-600 font-bold text-lg">+</a>
                                                    {% endif %}
                                                    </div>
                                                </td>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if change_logs %}
            <div class="mt-8">
                <h4 class="text-lg font-bold text-primary mb-4">Change Log (Week 1)</h4>
                <div class="bg-white shadow overflow-hidden sm:rounded-md border border-gray-200">
                    <ul role="list" class="divide-y divide-gray-200">
                        {% for log in change_logs %}
                            <li>
                                <div class="px-4 py-4 sm:px-6">
                                    <div class="flex items-center justify-between">
                                        <p class="text-sm font-medium text-primary truncate">
                                            {{ log.user.username|default:"System" }}
                                        </p>
                                        <div class="ml-2 flex-shrink-0 flex">
                                            <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                {{ log.created_at|date:"M d, H:i" }}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="mt-2 sm:flex sm:justify-between">
                                        <div class="sm:flex">
                                            <p class="flex items-center text-sm text-gray-500">
                                                {{ log.message }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

        {% else %}
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            No schedule generated yet. Click Generate to start.
                        </p>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
    function openTab(evt, tabId) {
        // Hide all tab content
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Deactivate all tab links
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" border-primary text-primary", " border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabId).style.display = "block";
        evt.currentTarget.className = evt.currentTarget.className.replace(" border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300", " border-primary text-primary");
    }

    // Initialize first tab open by default if tabs exist
    document.addEventListener("DOMContentLoaded", function(){
        const firstTab = document.querySelector('.tab-content');
        if(firstTab) {
            firstTab.style.display = "block";
        }
    });
</script>
{% endblock %}
